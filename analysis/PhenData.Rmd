---
title: "Prepare Phenotypic Data"
author: "LucianoRogerio"
date: "2022-04-26"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

In this Section we will obtain the deregressed BLUPs and BLUPs for each clone evaluated to tolerance to Foliar Disease in Cassava.

## Packages required

```{r read the packages}
library(here)
library(tidyverse)
library(sommer)
library(reshape2)
library(data.table)
```

## Read and prepare the Phenotypic data for the Mixed Models Analysis

```{r Read the Phenotypic data}
PhenoData <- read.table(file = here::here("data", "DadosDoencasBAG2021-22Henr.csv"),
                        header = T, sep = ",") %>%
  mutate(block_number = as.character(block_number),
         Year = ifelse(trial_name == "BR.PTBAG.20.Candeal", yes = "20", no = "21")) %>% 
  mutate(YearRep = factor(paste(Year, block_number, sep = "."))) %>% 
  dplyr::select(1:13, Year, YearRep, everything())

PhenoData2 <- tibble(Trait = PhenoData %>% colnames %>% tail(., 4),
                     PhenoData = list(tibble(PhenoData)))

PhenoData2$PhenoData[[1]] %<>% dplyr::select(-ManchaBranca, -ManchaParda,
                                             -QueimaFolhas) %>%
  dplyr::mutate(y = Anthractnose, .keep = "unused")
PhenoData2$PhenoData[[2]] %<>% dplyr::select(-Anthractnose, -ManchaParda,
                                             -QueimaFolhas) %>%
  dplyr::mutate(y = ManchaBranca, .keep = "unused")
PhenoData2$PhenoData[[3]] %<>% dplyr::select(-Anthractnose, -ManchaBranca,
                                             -QueimaFolhas) %>%
  dplyr::mutate(y = ManchaParda, .keep = "unused")
PhenoData2$PhenoData[[4]] %<>% dplyr::select(-Anthractnose, -ManchaBranca,
                                             -ManchaParda) %>%
  dplyr::mutate(y = QueimaFolhas, .keep = "unused")


head(PhenoData2)
```


## Mixed Models

```{r Mixed Models, eval = FALSE}
library(sommer); library(data.table); library(furrr)
library(tidyverse); library(magrittr)

plan(multisession, workers = 2)

PhenoData3 <- PhenoData2 %>%
  dplyr::mutate(MixMod=future_map2(Trait,PhenoData, function(Trait,PhenoData,...){
    cat("\n", "\n", "Trait ", Trait)
    MM <- mmer(fixed = y ~ 1,
               random = ~ accession_name + YearRep, getPEV = T, data = PhenoData)
    results <- tibble(clones = names(MM$U$accession_name$y) %>%
                        gsub(pattern = "accession_name", replacement = ""),
                      BLUP = MM$U$accession_name$y,
                      PEV = diag(MM$PevU$accession_name$y),
                      REL = 1 - PEV/MM$sigma$accession_name[,"y"],
                      drgBLUP = BLUP/REL)
    return(list(MixedModel = MM,
                Results = results))
  }))

plan(sequential)

Clones <- PhenoData3$MixMod[[1]]$Results %>% dplyr::select(clones)


for (i in 2:4) {
  Clones <- Clones %>% bind_rows(PhenoData3$MixMod[[i]]$Results %>% 
                                   dplyr::select(clones)) %>% unique()
}

Blups <- Clones
drgBlups <- Clones

for (i in 1:4) {
  Blups %<>% left_join(PhenoData3$MixMod[[i]]$Results %>% 
    dplyr::select(clones, BLUP))
  colnames(Blups)[ncol(Blups)] <- paste0("trait",i)
  drgBlups %<>% left_join(PhenoData3$MixMod[[i]]$Results %>% 
    dplyr::select(clones, drgBLUP))
  colnames(drgBlups)[ncol(drgBlups)] <- paste0("trait",i)
}

colnames(Blups)[2:ncol(Blups)] <- colnames(drgBlups)[2:ncol(drgBlups)] <- PhenoData3$Trait

write.table(Blups, file = here::here("output", "BlupsDoencas.csv"),
            quote = F, sep = ",", row.names = F)
write.table(drgBlups, file = here::here("output", "drgBlupsDoencas.csv"),
            quote = F, sep = ",", row.names = F)
```

